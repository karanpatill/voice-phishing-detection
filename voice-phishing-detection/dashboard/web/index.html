<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Voice Phishing Detection â€” File Upload</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#071021; color:#e6eef6; font-family: Inter, system-ui, sans-serif; padding: 30px; }
    .panel { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 18px; box-shadow: 0 6px 30px rgba(0,0,0,0.6); }
    #results { margin-top:18px; max-height:380px; overflow:auto; }
    .result-card { background:#0f1720; border-left:4px solid #00ffc3; padding:12px; border-radius:8px; margin-bottom:10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h3 style="color:#00ffc3">Upload Audio File</h3>
      <p>Select a WAV file to get the phishing detection prediction.</p>

      <div class="mb-3">
        <label class="form-label">Call ID</label>
        <input id="callId" class="form-control" placeholder="call_demo_001" value="call_demo_001" />
      </div>

      <div class="mb-3">
        <input type="file" id="audioFile" accept=".wav,.mp3,.ogg,.webm" class="form-control" />
      </div>

      <button id="uploadBtn" class="btn btn-primary">Upload & Predict</button>

      <div id="results"></div>
    </div>
  </div>

<script>
const uploadBtn = document.getElementById('uploadBtn');
const audioFileInput = document.getElementById('audioFile');
const resultsDiv = document.getElementById('results');
const callIdInput = document.getElementById('callId');

uploadBtn.onclick = async () => {
  const file = audioFileInput.files[0];
  if (!file) {
    alert("Please select an audio file first!");
    return;
  }
  const callId = callIdInput.value || "call_demo_001";

  const form = new FormData();
  form.append('file', file);
  form.append('call_id', callId);
  form.append('chunk_number', 0); // single file, chunk_number = 0

  // Show a placeholder card
  const card = document.createElement('div');
  card.className = 'result-card';
  card.innerHTML = `<strong>Processing ${file.name}...</strong>`;
  resultsDiv.prepend(card);

  try {
    const resp = await fetch('/upload_chunk/', { method: 'POST', body: form });
    const data = await resp.json();

    if (data.error) {
      card.innerHTML = `<strong>Error:</strong> ${data.error}`;
      return;
    }

    const normalPct = (data.prediction.normal * 100).toFixed(1);
    const phishingPct = (data.prediction.phishing * 100).toFixed(1);

    let color = '#00e676';
    if (data.prediction.phishing > 0.6) color = '#ff4c4c';
    else if (data.prediction.phishing > 0.3) color = '#ffb74d';

    card.innerHTML = `
      <div><strong>Call ID:</strong> ${data.call_id}</div>
      <div><strong>Transcript:</strong> ${escapeHtml(data.transcript)}</div>
      <div><strong>Prediction:</strong> <span style="color:${color}">${phishingPct}% Phishing</span></div>
      <div style="margin-top:5px;"><a href="${data.file_url}" target="_blank" style="color:#9be7c4">ðŸ”Š Listen</a></div>
    `;

  } catch (err) {
    card.innerHTML = `<strong>Error uploading file:</strong> ${err.message}`;
    console.error(err);
  }
};

function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
}
</script>

</body>
</html>
